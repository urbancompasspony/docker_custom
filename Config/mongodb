#!/bin/bash

# Aguarda o MongoDB estar pronto
until mongosh --eval "print(\"waited for connection\")"
do
    sleep 2
done

# Cria o usuário unifi com as permissões necessárias
mongosh <<EOF
use admin

// Cria o usuário unifi com permissões completas nos databases necessários
db.createUser({
  user: "unifi",
  pwd: "$MONGO_PASS",
  roles: [
    { role: "dbOwner", db: "unifi" },
    { role: "dbOwner", db: "unifi_stat" }, 
    { role: "dbOwner", db: "unifi_audit" },
    { role: "readWrite", db: "admin" }
  ]
})

// Verifica se o usuário foi criado corretamente
print("Usuário unifi criado com sucesso")

// Cria os databases vazios para garantir que existam
use unifi
db.createCollection("dummy")

use unifi_stat  
db.createCollection("dummy")

use unifi_audit
db.createCollection("dummy")

print("Databases unifi, unifi_stat e unifi_audit criados")
EOF
